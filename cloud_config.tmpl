#cloud-config

hostname: {{ coreos_hostname }}
coreos:
  update:
    group: "{{coreos_channel}}"
    reboot-strategy: "{{coreos_reboot_strategy}}"
  flannel:
    interface: {{ inventory_hostname }}
  locksmith:
    endpoint: https://{{ inventory_hostname }}:2379
    etcd_cafile: /etc/ssl/etcd/ca.crt
    etcd_certfile: /etc/ssl/etcd/key.crt
    etcd_keyfile: /etc/ssl/etcd/key.key
  units:
{% if gateway is defined and route_destination is defined %}
    - name: 10-static.network
      content: |
        [Route]
        Gateway={{ gateway }}
        Destination={{ route_destination }}
{% endif  %}
    - name: serial-getty@ttyS1.service
      command: start
      enable: true
    - name: etcd-member.service
      command: start
      enable: true
      drop-ins:
        - name: 40-etcd-cluster.conf
          content: |
            [Service]
            ExecStartPre=/usr/bin/route
{% if etcd_image_tag is defined %}
            Environment="ETCD_IMAGE_TAG={{ etcd_image_tag }}"
{% endif  %}
            Environment="ETCD_NAME={{ coreos_hostname }}"
            Environment="ETCDCTL_CA_FILE=/etc/ssl/etcd/ca.crt"
            Environment="ETCDCTL_KEY_FILE=/etc/ssl/etcd/key.key"
            Environment="ETCDCTL_CERT_FILE=/etc/ssl/etcd/key.crt"
            Environment="ETCD_SSL_DIR=/etc/ssl/etcd"
            Environment="ETCD_PEER_CA_FILE=/etc/ssl/certs/ca.crt"
            Environment="ETCD_PEER_CERT_FILE=/etc/ssl/certs/key.crt"
            Environment="ETCD_PEER_KEY_FILE=/etc/ssl/certs/key.key"
            Environment="ETCD_CA_FILE=/etc/ssl/certs/ca.crt"
            Environment="ETCD_CERT_FILE=/etc/ssl/certs/key.crt"
            Environment="ETCD_KEY_FILE=/etc/ssl/certs/key.key"
            Environment="ETCD_INITIAL_CLUSTER={% for host in groups['etcd-node'] %}{{ hostvars[host]['coreos_hostname'] }}=https://{{host}}:2380{%if not loop.last %},{% endif %}{% endfor %}"
            Environment="ETCD_ADVERTISE_CLIENT_URLS=https://{{ inventory_hostname }}:2379"
            Environment="ETCD_INITIAL_ADVERTISE_PEER_URLS=https://{{ inventory_hostname }}:2380"
            Environment="ETCD_LISTEN_CLIENT_URLS=https://0.0.0.0:2379,https://0.0.0.0:4001"
            Environment="ETCD_LISTEN_PEER_URLS=https://{{ inventory_hostname }}:2380"
    {% if inventory_hostname in groups['etcd-proxy'] %}
            Environment="ETCD_PROXY=on"
    {% endif %}

    - name: flanneld.service
      enable: true
      command: start
      drop-ins:
      - name: 50-network-config.conf
        content: |
          [Unit]
          Requires=etcd-member.service
          After=etcd-member.service
          [Service]
          EnvironmentFile=/etc/environment
          ExecStartPre=/usr/bin/etcdctl set /coreos.com/network/config '{ "Network": "{{coreos_flanneld_subnet}}" }'
    - name: prepare-data-drive.service
      command: start
      enable: true
      content: |
        [Unit]
        Description=Prepare data drive
        Ater=dev-sdb.device
        Requires=dev-sdb.device
        ConditionPathExists=!/dev/sdb1
        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/sbin/wipefs -f /dev/sdb
        ExecStart=/usr/sbin/parted -s -a opt /dev/sdb mklabel gpt -- mkpart primary ext4 2048s -1
        ExecStart=/usr/sbin/parted -s /dev/sdb align-check optimal 1
        ExecStart=/usr/sbin/mkfs.ext4 -m 1 -F /dev/sdb1
    - name: mnt-data.mount
      command: start
      enable: true
      content: |
        [Unit]
        After=prepare-data-drive.service
        Requires=prepare-data-drive.service
        [Mount]
        What=/dev/sdb1
        Where=/mnt/data
        Type=ext4
        Options=rw,noatime,nodiratime,discard,data=ordered
    - name: "00-wired.network"
      runtime: true
      content: |
        [Match]
        Name=en*
        [Network]
        DHCP=true
{% if cluster_failover_ips is defined %}
{% for ip in cluster_failover_ips.split(';') %}
        Address={{ ip }}
{% endfor %}
{% endif  %}

    - name: iptables-restore.service
      command: start
      enable: true
    - name: settimezone.service
      command: start
      enable: true
      content: |
        [Unit]
        Description=Set the time zone
        [Service]
        ExecStart=/usr/bin/timedatectl set-timezone {{coreos_timezone}}
        RemainAfterExit=yes
        Type=oneshot
    - name: systemd-modules-load.service
      command: restart
    - name: systemd-sysctl.service
      command: restart
    - name: systemd-timesyncd.service
      command: start
      enable: true
    - name: docker.service
      command: start
      drop-ins:
        - name: 40-flannel.conf
          content: |
            [Unit]
            Requires=flanneld.service
            After=flanneld.service
            [Service]
            EnvironmentFile=/etc/kubernetes/cni/docker_opts_cni.env
    - name: docker-tcp.socket
      command: start
      enable: true
      content: |
        [Unit]
        Description=Docker Socket for the API
        After=mnt-data.mount
        Requires=mnt-data.mount
        [Socket]
        ListenStream=2375
        Service=docker.service
        BindIPv6Only=both
        [Install]
        WantedBy=sockets.target

write_files:
  - path: /etc/environment
    permissions: 0774
    owner: root
    content: |
      COREOS_PUBLIC_IPV4={{ inventory_hostname }}
      ETCD_SSL_DIR=/etc/ssl/etcd
      ETCDCTL_CA_FILE=/etc/ssl/etcd/ca.crt
      ETCDCTL_KEY_FILE=/etc/ssl/etcd/key.key
      ETCDCTL_CERT_FILE=/etc/ssl/etcd/key.crt
      ETCDCTL_PEERS="{% for host in groups['etcd-node'] %}https://{{host}}:2379{%if not loop.last %},{% endif %}{% endfor %}"
      FLANNELD_ETCD_ENDPOINTS=https://{{ inventory_hostname }}:2379
      FLANNELD_ETCD_KEYFILE=/etc/ssl/etcd/key.key
      FLANNELD_ETCD_CERTFILE=/etc/ssl/etcd/key.crt
      FLANNELD_ETCD_CAFILE=/etc/ssl/etcd/ca.crt
      LOCKSMITHCTL_ETCD_CAFILE=/etc/ssl/etcd/ca.crt
      LOCKSMITHCTL_ETCD_KEYFILE=/etc/ssl/etcd/key.key
      LOCKSMITHCTL_ETCD_CERTFILE=/etc/ssl/etcd/key.crt
      LOCKSMITHCTL_ENDPOINT=https://{{ inventory_hostname }}:2379
  - path: /etc/etcd-client.config.json
    permissions: '0644'
    content: |
       {
         "cluster": {
         "machines": [ "https://{{ inventory_hostname }}:2379" ] },
         "config": {
            "caCertFiles": [ "/etc/ssl/etcd/ca.crt" ],
            "keyFile": "/etc/ssl/etcd/key.key",
            "certFile": "/etc/ssl/etcd/key.crt",
         "timeout": 5000000000,
         "consistency": "WEAK"
         }
       }
  - path: "/home/core/.toolboxrc"
    owner: core
    content: |
      TOOLBOX_DOCKER_IMAGE={{coreos_toolbox_docker_image}}
      TOOLBOX_DOCKER_TAG={{coreos_toolbox_docker_tag}}
  - path: /etc/kubernetes/cni/docker_opts_cni.env
    content: |
      DOCKER_OPT_BIP=""
      DOCKER_OPT_IPMASQ=""
  - path: /etc/modules-load.d/nf.conf
    content: nf_conntrack
  - path: /etc/sysctl.d/ipv4_forward.conf
    content: net.ipv4.ip_forward=1
  - path: /etc/sysctl.d/swapiness.conf
    content: vm.swappiness=1
  - path: /etc/sysctl.d/overcommit_memory.conf
    content: vm.overcommit_memory=1
  - path: /etc/sysctl.d/max_map_count.conf
    content: vm.max_map_count=65535
  {% if extra_cas.results is defined %}
  {% for item in extra_cas.results %}

  - path: /etc/ssl/certs/{{ item.item|basename }}
    encoding: base64
    content: |
      {{ item.content|indent(width=6) }}
  {% endfor %}
  {% endif %}

  - path: /opt/bin/wupiao
    permissions: '0755'
    content: |
      #!/bin/bash
      # [w]ait [u]ntil [p]ort [i]s [a]ctually [o]pen
      [ -n "$1" ] && \
        until curl -o /dev/null -sIf http://${1}; do \
          sleep 1 && echo .;
        done;
      exit $?
  - path: /etc/ssl/etcd/ca.crt
    permissions: 0644
    content: |
      {{ etcd_ca_certificate|indent(width=6) }}

  - path: /etc/ssl/etcd/key.crt
    permissions: 0644
    content: |
      {{ etcd_cert|indent(width=6) }}

  - path: /etc/ssl/etcd/key.key
    permissions: 0644
    content: |
      {{ etcd_key|indent(width=6) }}

  - path: /etc/hosts
    content: |
      127.0.0.1       localhost {{ coreos_hostname }}
      ::1             localhost

  - path: /var/lib/iptables/rules-save
    permissions: 0644
    owner: root:root
    content: |
      *filter
      :INPUT ACCEPT [0:0]
      :FORWARD ACCEPT [0:0]
      :OUTPUT ACCEPT [0:0]
      -A INPUT -i lo -j ACCEPT
      -A INPUT -s {% for host in groups['coreos'] %}{{host}}{%if not loop.last %},{% endif %}{% endfor %} -j ACCEPT
      -A INPUT -i tap0 -p all -j ACCEPT
      -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
      -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
      -A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
      -A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
      -A INPUT -p icmp -m icmp --icmp-type 0 -j ACCEPT
      -A INPUT -p icmp -m icmp --icmp-type 3 -j ACCEPT
      -A INPUT -p icmp -m icmp --icmp-type 11 -j ACCEPT
      -A INPUT -j DROP
      COMMIT

ssh_authorized_keys:
  - "{{  lookup('file', '~/.ssh/id_rsa.pub') }}"
{% for key in coreos_public_keys %}
  - "{{ key }}"
{% endfor %}
